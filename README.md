[![Documentation](https://img.shields.io/badge/jeelabs.org-docs-blue)](https://monty.jeelabs.org/)
[![Discussions](https://img.shields.io/badge/github-discuss-orange)](https://github.com/jeelabs/monty/discussions)
[![GitHub issues](https://img.shields.io/github/issues/jeelabs/monty)](https://github.com/jeelabs/monty/milestones)

**Monty** is a Virtual Machine which runs bytecode produced by [MicroPython][MPY].  
It's grossly incomplete and totally unfit for general use, but ... it _does_ work.  
There is no compiler, this VM uses `.mpy` files generated by `mpy-cross`.

This project is written from the ground up in C++, but it would not exist without  
the huge amount of thought and work put into the development of MicroPython,  
which proves that a modern dynamic language can run well on embedded µCs.

The reasons for creating this project are: to explore some stackless design ideas  
and to fit more features (multi-tasking, garbage-collection, dataflow) in tiny µCs.  
Monty can be used in as little as 64 kB flash and 8 kB RAM, but the default dev  
target is a low-power ARM Cortex-M4 [Nucleo-L432KC][L432] (256+64 kB @ 80 MHz).

**Features**  
» The µC runs bytecode from `mpy-cross` (no compiler or `eval`/`exec`)  
» Modules are imported as bytecode from a flash-based filesystem  
» Rich data structures, usable from C++ as well as Python  
» Mark-and-sweep garbage collection with compacting vectors  
» Small code base, well under 10,000 lines of C++ for the core + VM  
» Most non-hardware features can also be used on MacOS and Linux  
» C++ and Python test suites are used to drive (and verify) progress  
» Goals: support messaging, dataflow, and scripting on low-power µCs  
» Non-goals: full Python conformance, replicating MicroPython  
» This is experimental code: some things work, many don't, asserts will fail  

**Requirements**  
» [MPy cross compiler][MPX] for bytecode generation  
» [PlatformIO][PIO] for native and embedded builds  
» [PyInvoke][INV] for general development workflow  
» Good familiarity with C++17 and Python 3  
» Lots of patience and a long-term perspective :-)

This is a test run on native + embedded, as of April 2021:

```text
$ cat verify/hello.py
import sys
print('hello', sys.implementation, sys.version)
$ inv native -f verify/hello.mpy
main
hello monty v1.1-22-g9e2d42d
done
$ inv all
Test    Environment    Status    Duration
------  -------------  --------  ------------
array   native         PASSED    00:00:01.582
data    native         PASSED    00:00:00.674
mem     native         PASSED    00:00:00.697
repr    native         PASSED    00:00:00.686
============================ 4 succeeded in 00:00:03.639 ============================
42 tests, 42 matches, 0 failures, 4 skipped, 0 ignored
Test    Environment    Status    Duration
------  -------------  --------  ------------
array   nucleo-l432    PASSED    00:00:05.551
data    nucleo-l432    PASSED    00:00:03.587
mem     nucleo-l432    PASSED    00:00:03.781
repr    nucleo-l432    PASSED    00:00:03.551
============================ 4 succeeded in 00:00:16.469 ============================
Processing nucleo-l432 (board: nucleo_l432kc; platform: ststm32; framework: cmsis)
STM32 STLink: /dev/cu.usbmodem145102 ser# 066BFF555052836687031442
upload 0x05360 done, 21344 bytes sent
STM32 STLink: /dev/cu.usbmodem145102 ser# 066BFF555052836687031442
43 tests, 43 matches, 0 failures, 1 skipped, 2 ignored
   text	   data	    bss	    dec	    hex	filename
  55640	   2740	   2472	  60852	   edb4	.pio/build/nucleo-l432/firmware.elf
  46048	   2740	   2472	  51260	   c83c	.pio/build/noassert/firmware.elf
  35996	   2544	   2472	  41012	   a034	.pio/build/nopyvm/firmware.elf
[...]
```

The source code & docs are in the public domain and under active development.  
Monty started in June 2020 as a friendly chat between Jean-Claude Wippler and  
Thorsten von Eicken. And then it evolved into an adventure full of discoveries ...

[MPY]: https://micropython.org/
[L432]: https://www.st.com/en/evaluation-tools/nucleo-l432kc.html
[PIO]: https://docs.platformio.org/en/latest/
[MPX]: https://github.com/micropython/micropython/tree/master/mpy-cross
[INV]: https://www.pyinvoke.org/
